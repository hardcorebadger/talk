package trefethen.talk.chat;

import java.io.FileReader;
import java.io.FileWriter;
import java.util.HashMap;
import java.util.Iterator;

import org.json.simple.JSONArray;
import org.json.simple.JSONObject;
import org.json.simple.parser.JSONParser;

import trefethen.talk.user.User;

public class ChatManager {
	
	private static String chatDataFile = "resources/chats.json";
	
	private static HashMap<Integer, Chat> chats = new HashMap<Integer, Chat>();
	
	private int nextID = 0;
	
	@SuppressWarnings("unchecked")
	public static void loadChats() {
		System.out.println("USER MANAGER : Loading Users...");
		JSONParser parser = new JSONParser();
		try {
            Object obj = parser.parse(new FileReader(userDataFile));
            JSONObject jsonObject = (JSONObject) obj;
            JSONArray userJSON = (JSONArray) jsonObject.get("Users");
            Iterator<JSONObject> iterator = userJSON.iterator();
            while (iterator.hasNext()) {
            	JSONObject userObject = iterator.next();
            	User u = new User(userObject);                
            	users.put(u.getID(), u);
                nextID = Math.max(nextID, u.getID() + 1); // not the safest but hey you can't delete users so
            }
            System.out.println("USER MANAGER : Users Loaded!");
		} catch (Exception e) {
            e.printStackTrace();
        }
	}
	
	@SuppressWarnings("unchecked")
	public static void saveChats() {
		System.out.println("CHAT MANAGER : Saving Users...");
		try {
			JSONArray usersArray = new JSONArray();
			Iterator<Chat> iterator = chats.values().iterator();
			while (iterator.hasNext()) {
				usersArray.add(iterator.next().toJSON());
			}
			JSONObject obj = new JSONObject();
			obj.put("Chats", usersArray);
			
			FileWriter file = new FileWriter(chatDataFile);
			file.write(obj.toJSONString());
			file.close();
			System.out.println("CHAT MANAGER : Users Saved!");
		} catch (Exception e) {
            e.printStackTrace();
        }
	}
	
	public static void displayChats() {
		Iterator<Chat> iterator = chats.values().iterator();
		while (iterator.hasNext()) {
			iterator.next().display();
		}
	}

}
